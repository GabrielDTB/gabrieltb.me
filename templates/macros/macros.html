                                                                                                      {%
macro translate(key, i18n="", default="")                                                           %}{{
  i18n[key] | default(value=default) | safe                                                         }}{%
endmacro                                                                                            %}{%

macro page_listing(page, config)                                                                    %}{% filter trim %}
  <div class="tpad"><a href="{{ page.permalink | safe}}">{{ page.title }}</a></div>                   {% endfilter %}{%
endmacro                                                                                            %}{%

macro series_link(inner, page, config)                                                              %}{% filter trim %}
  <li><a                                                                                              {%
    if inner.content == page.content                                                                %}
      class="scur"                                                                                    {%
    endif                                                                                           %}
    href="{{ inner.permalink | safe }}"
  >{{ inner.title }}</a></li>                                                                         {% endfilter %}{%
endmacro                                                                                            %}{%

macro title_post(page, config)                                                                      %}{% filter trim %}
  <h1><a href="{{ page.permalink | safe }}">{{ page.title }}</a></h1>                                 {% endfilter %}{%
endmacro                                                                                            %}{%

macro meta_post(page, config)                                                                       %}{#
  // Load current language i18n data from .toml files in user's '/i18n' folder,
  // use theme as fallback.                                                                         #}{%
  set i18n = load_data(path="i18n/" ~ lang ~ '.toml', required=false)                               %}{%
  if not i18n                                                                                       %}{%
    set i18n = load_data(path="themes/abridge/i18n/" ~ lang ~ ".toml", required=false)              %}{%
  endif                                                                                             %}{%
  set extra = config.extra                                                                          %}{%
  set meta = extra.meta_post                                                                        %}{% filter trim %}
  <span                                                                                               {%
    if meta.size                                                                                    %}
      class="{{ meta.size }}"                                                                         {%
    endif                                                                                           %}
  >                                                                                                   {% endfilter %}{#

    // Author                                                                                       #}{%
    if meta.author                                                                                  %}{%
      if extra.icon_author                                                                          %}{% filter trim %}
        <i class="{{ extra.icon_author }}"></i>                                                       {% endfilter %}{%
      endif                                                                                         %}{{
      extra.author                                                                                  }}{#
      // divider                                                                                    #}{%
      if meta.readtime or meta.date or meta.updated or meta.categories_tags                         %}{%
        if meta.divider                                                                             %}{% filter trim %}
          <span class="hpad">{{ meta.divider | safe }}</span>                                         {% endfilter %}{%
        else                                                                                        %}{% filter trim %}
          <span class="rpad"> </span>                                                                 {% endfilter %}{%
        endif                                                                                       %}{%
      endif                                                                                         %}{%
    endif                                                                                           %}{#

    // ReadTime                                                                                     #}{%
    if meta.readtime                                                                                %}{%
      if extra.icon_read                                                                            %}{% filter trim %}
        <i class="{{ extra.icon_read }}"></i>                                                         {% endfilter %}{%
      endif                                                                                         %}{{
      page.reading_time ~ " min read" | replace(from=" ", to="&nbsp") | safe                        }}{#
      // divider                                                                                    #}{%
      if meta.date or meta.updated or meta.categories_tags                                          %}{%
        if meta.divider                                                                             %}{% filter trim %}
          <span class="hpad">{{ meta.divider | safe}}</span>                                          {% endfilter %}{%
        else                                                                                        %}{% filter trim %}
          <span class="rpad"> </span>                                                                 {% endfilter %}{%
        endif                                                                                       %}{%
      endif                                                                                         %}{%
    endif                                                                                           %}{#

    // Date                                                                                         #}{%
    if meta.date                                                                                    %}{%
      if extra.icon_date                                                                            %}{% filter trim %}
        <i class="{{ extra.icon_date }}"></i>                                                         {% endfilter %}{%
      endif                                                                                         %}{%
      if extra.date_locale                                                                          %}{%
        if lang != config.default_language                                                          %}{%
          set lang_locale = macros::translate(key='date_locale', default='en_US', i18n=i18n)        %}{%
        else                                                                                        %}{%
          set lang_locale = extra.date_locale                                                       %}{%
        endif                                                                                       %}{{
        page.date | date(format="%B&nbsp;%d,&nbsp;%Y", locale=lang_locale) | safe                   }}{%
      else                                                                                          %}{{
        page.date | date(format="%B&nbsp;%d,&nbsp;%Y") | safe                                       }}{%
      endif                                                                                         %}{#
      // divider                                                                                    #}{%
      if meta.updated or meta.categories_tags                                                       %}{%
        if meta.divider                                                                             %}{% filter trim %}
          <span class="hpad">{{ meta.divider | safe}}</span>                                          {% endfilter %}{%
        else                                                                                        %}{% filter trim %}
          <span class="rpad"> </span>                                                                 {% endfilter %}{%
        endif                                                                                       %}{%
      endif                                                                                         %}{%
    endif                                                                                           %}{#

    // Updated                                                                                      #}{%
    if meta.updated and page.updated                                                                %}{%
      if extra.icon_date                                                                            %}{% filter trim %}
        <i class="{{ extra.icon_date }}"></i>                                                         {% endfilter %}{%
      endif                                                                                         %}{%
      if extra.date_locale                                                                          %}{%
        if lang != config.default_language                                                          %}{%
          set lang_locale = macros::translate(key='date_locale', default='en_US', i18n=i18n)        %}{%
        else                                                                                        %}{%
          set lang_locale = extra.date_locale                                                       %}{%
        endif                                                                                       %}{% filter trim %} 
        <em>                                                                                          {% endfilter %}{{
          page.updated | date(format="%B&nbsp;%d,&nbsp;%Y", locale=lang_locale) | safe              }}{% filter trim %}
        </em>                                                                                         {% endfilter %}{%
      else                                                                                          %}{% filter trim %}
        <em>                                                                                          {% endfilter %}{{
          page.updated | date(format="(%B&nbsp;%d,&nbsp;%Y)") | safe                                }}{% filter trim %}
        </em>                                                                                         {% endfilter %}{%
      endif                                                                                         %}{#
      // divider                                                                                    #}{%
      if meta.categories_tags                                                                       %}{%
        if meta.divider                                                                             %}{% filter trim %}
          <span class="hpad">{{ meta.divider | safe}}</span>                                          {% endfilter %}{%
        else                                                                                        %}{% filter trim %}
          <span class="rpad"> </span>                                                                 {% endfilter %}{%
        endif                                                                                       %}{%
      endif                                                                                         %}{%
    endif                                                                                           %}{#

    // Categories                                                                                   #}{%
    if page.taxonomies.categories                                                                   %}{%
      if extra.icon_info                                                                            %}{% filter trim %}
        <i class="{{ extra.icon_info }}"></i>                                                         {% endfilter %}{%
      endif                                                                                         %}{% filter trim %}
      [                                                                                               {% endfilter %}{%
      for cat in page.taxonomies.categories                                                         %}{% filter trim %}
        <a href="
          {{ get_taxonomy_url(kind='categories', name=cat, lang=lang) | safe }}
        ">{{ cat }}</a>                                                                               {% endfilter %}{%
      endfor                                                                                        %}{% filter trim %}
      ]                                                                                               {% endfilter %}{%
    endif                                                                                           %}{#

    // Tags                                                                                         #}{%
    if page.taxonomies.tags                                                                         %}{%
      for tag in page.taxonomies.tags                                                               %}{% filter trim %}
        #<a href="
          {{ get_taxonomy_url(kind='tags', name=tag, lang=lang) | safe }}
        ">{{ tag }}&nbsp;</a>                                                                         {% endfilter %}{%
      endfor                                                                                        %}{%
    endif                                                                                           %}{% filter trim %}
  </span>                                                                                             {% endfilter %}{%
endmacro                                                                                            %}{%

macro title_index(page, config)                                                                     %}{%
  set index = config.extra.title_size_index                                                         %}{%
  if config.extra.offline                                                                           %}{%
    set uglyurls = true                                                                             %}{%
  endif                                                                                             %}{% filter trim %}
  <h1>                                                                                                {% endfilter %}{%
    if index                                                                                        %}{% filter trim %}
      <span class="{{ index }}">                                                                      {% endfilter %}{%
    endif                                                                                           %}{% filter trim %}
    <a href="{{ page.permalink | safe }}">{{ page.title }}</a>                                        {% endfilter %}{%
    if index                                                                                        %}{% filter trim %}
      </span>                                                                                         {% endfilter %}{%
    endif                                                                                           %}{% filter trim %}
  </h1>                                                                                               {% endfilter %}{%
endmacro                                                                                            %}{%

macro meta_index(page, config)                                                                      %}{#
  // Load current language i18n data from .toml files in user's '/i18n' folder,
  // use theme as fallback.                                                                         #}{%
  set i18n = load_data(path="i18n/" ~ lang ~ '.toml', required=false)                               %}{%
  if not i18n                                                                                       %}{%
    set i18n = load_data(path="themes/abridge/i18n/" ~ lang ~ ".toml", required=false)              %}{%
  endif                                                                                             %}{%
  set extra = config.extra                                                                          %}{%
  set meta = config.extra.meta_index                                                                %}{% filter trim %}
  <span                                                                                               {% endfilter %}{%
    if meta.size                                                                                    %}
      class="{{ meta.size }}"                                                                         {%
    endif                                                                                           %}
  >                                                                                                   {#
  
    // Author                                                                                       #}{%
    if extra.author and extra.meta_index.author                                                     %}{%
      if extra.icon_author                                                                          %}{% filter trim %}
        <i class="{{ extra.icon_author }}"></i>                                                       {% endfilter %}{%
      endif                                                                                         %}{{ 
      extra.author                                                                                  }}{#
      // divider                                                                                    #}{%
      if meta.readtime or meta.date or meta.updated or meta.categories_tags                         %}{%
        if meta.divider                                                                             %}{% filter trim %}
          <span class="hpad">{{ meta.divider | safe }}</span>                                         {% endfilter %}{%
        else                                                                                        %}{% filter trim %}
          <span class="rpad"></span>                                                                  {% endfilter %}{%
        endif                                                                                       %}{%
      endif                                                                                         %}{%
    endif                                                                                           %}{#
  
    // ReadTime                                                                                     #}{%
    if meta.readtime                                                                                %}{%
      if extra.icon_read                                                                            %}{% filter trim %}
        <i class="{{ extra.icon_read }}"></i>                                                         {% endfilter %}{%
      endif                                                                                         %}{{
      page.reading_time                                                                             }}{{
      meta.readstring | default(value="min")                                                        }}{#
      // divider                                                                                    #}{%
      if meta.date or meta.updated or meta.categories_tags                                          %}{%
        if meta.divider                                                                             %}{% filter trim %}
          <span class="hpad">{{ meta.divider | safe }}</span>                                         {% endfilter %}{%
        else                                                                                        %}{% filter trim %}
          <span class="rpad"></span>                                                                  {% endfilter %}{%
        endif                                                                                       %}{%
      endif                                                                                         %}{%
    endif                                                                                           %}{#
  
    //Date                                                                                          #}{%
    if meta.date                                                                                    %}{%
      if extra.icon_date                                                                            %}{% filter trim %}
        <i class="{{ extra.icon_date }}"></i>                                                         {% endfilter %}{%
      endif                                                                                         %}{%
      if extra.date_locale                                                                          %}{%
        if lang != config.default_language                                                          %}{%
          set lang_locale = macros::translate(key='date_locale', default='en_US', i18n=i18n)        %}{%
        else                                                                                        %}{%
          set lang_locale = extra.date_locale                                                       %}{%
        endif                                                                                       %}{{
        page.date | date(format="%B&nbsp;%d,&nbsp;%Y", locale=lang_locale) | safe                   }}{%
      else                                                                                          %}{{
        page.date | date(format="%B&nbsp;%d,&nbsp;%Y") | safe                                       }}{%
      endif                                                                                         %}{#
      // divider                                                                                    #}{%
      if meta.updated or meta.categories_tags                                                       %}{%
        if meta.divider                                                                             %}{% filter trim %}
          <span class="hpad">{{ meta.divider | safe }}</span>                                         {% endfilter %}{%
        else                                                                                        %}{% filter trim %}
          <span class="rpad"> </span>                                                                 {% endfilter %}{%
        endif                                                                                       %}{%
      endif                                                                                         %}{%
    endif                                                                                           %}{#
  
    // Updated                                                                                      #}{%
    if meta.updated and page.updated                                                                %}{%
      if extra.icon_date                                                                            %}{% filter trim %}
        <i class="{{ extra.icon_date }}"></i>                                                         {% endfilter %}{%
      endif                                                                                         %}{%
      if extra.date_locale                                                                          %}{%
        if lang != config.default_language                                                          %}{%
          set lang_locale = macros::translate(key='date_locale', default='en_US', i18n=i18n)        %}{%
        else                                                                                        %}{%
          set lang_locale = extra.date_locale                                                       %}{%
        endif                                                                                       %}{% filter trim %} 
        <em>                                                                                          {% endfilter %}{{
          page.updated | date(format="%B&nbsp;%d,&nbsp;%Y", locale=lang_locale) | safe              }}{% filter trim %}
        </em>                                                                                         {% endfilter %}{%
      else                                                                                          %}{% filter trim %}
        <em>                                                                                          {% endfilter %}{{
          page.updated | date(format="(%B&nbsp;%d,&nbsp;%Y)") | safe                                }}{% filter trim %}
        </em>                                                                                         {% endfilter %}{%
      endif                                                                                         %}{#
      // divider                                                                                    #}{%
      if meta.categories_tags                                                                       %}{%
        if meta.divider                                                                             %}{% filter trim %}
          <span class="hpad">{{ meta.divider | safe }}</span>                                         {% endfilter %}{%
        else                                                                                        %}{% filter trim %}
          <span class="rpad"> </span>                                                                 {% endfilter %}{%
        endif                                                                                       %}{%
      endif                                                                                         %}{%
    endif                                                                                           %}{#

    // Categories                                                                                   #}{%
    if page.taxonomies.categories                                                                   %}{%
      if extra.icon_info                                                                            %}{% filter trim %}
        <i class="{{ extra.icon_info }}"></i>                                                         {% endfilter %}{%
      endif                                                                                         %}{% filter trim %}
      [                                                                                               {% endfilter %}{%
      for cat in page.taxonomies.categories                                                         %}{% filter trim %}
        <a href="
          {{ get_taxonomy_url(kind='categories', name=cat, lang=lang) | safe }}
        ">{{ cat }}</a>                                                                               {% endfilter %}{%
      endfor                                                                                        %}{% filter trim %}
      ]                                                                                               {% endfilter %}{%
    endif                                                                                           %}{#
    // Tags                                                                                         #}{%
    if page.taxonomies.tags                                                                         %}{%
      for tag in page.taxonomies.tags                                                               %}{% filter trim %}
        #<a href="
          {{ get_taxonomy_url(kind='tags', name=tag, lang=lang) | safe }}
        ">{{ tag }}&nbsp</a>                                                                          {% endfilter %}{%
      endfor                                                                                        %}{%
    endif                                                                                           %}{% filter trim %}
  </span>                                                                                             {% endfilter %}{%
endmacro                                                                                            %}{%

macro footer(page, config)                                                                          %}{#
  // prev/next content page nextprev title pagination                                               #}{%
  if not config.extra.hide_page_nextprev_titles | default(value=false)                              %}{%
    if page.lower or page.higher                                                                    %}{% filter trim %}
      <nav>                                                                                           {% endfilter %}{% filter trim %}
        <div>                                                                                         {% endfilter %}{%
          if page.lower                                                                             %}{% filter trim %}
            <a href="{{ page.lower.permalink | safe }}"
              >&#8249; {{ page.lower.title | truncate(length=100) }}                                  {% endfilter %}{% filter trim %}
            </a>                                                                                      {% endfilter %}{%
          endif                                                                                     %}{% filter trim %}
        </div>                                                                                        {% endfilter %}{% filter trim %}
        <div>                                                                                         {% endfilter %}{%
          if page.higher                                                                            %}{% filter trim %}
            <a href="{{ page.higher.permalink | safe }}"
              > {{ page.higher.title | truncate(length=100) }} &#8250;                                {% endfilter %}{% filter trim %}
            </a>                                                                                      {% endfilter %}{%
          endif                                                                                     %}{% filter trim %}
        </div>                                                                                        {% endfilter %}{% filter trim %}
      </nav>                                                                                          {% endfilter %}{%
    endif                                                                                           %}{%
  endif                                                                                             %}{%
endmacro footer                                                                                     %}{%

macro pagination(paginator, config)                                                                 %}{%
  if paginator.number_pagers > 1                                                                    %}{%
    if paginator.number_pagers <= 5                                                                 %}{#
      // 5 or less pager is simple, just display all 5                                              #}{%
      set start = 1                                                                                 %}{%
      set end = paginator.number_pagers                                                             %}{%
    endif                                                                                           %}{%
    if paginator.number_pagers > 5                                                                  %}{%
      if paginator.current_index >= 3                                                               %}{#
        // Check if the first number will be 1 or not                                               #}{%
        set start = paginator.current_index - 2                                                     %}{#
        // Set the start number                                                                     #}{%
        if paginator.number_pagers - paginator.current_index < 2                                    %}{#
        // the last two pages your no longer centered with equal pages start and end                #}{%
          set difference = paginator.number_pagers - paginator.current_index                        %}{%
          set compensation =  1 - difference                                                        %}{%
          set start = paginator.current_index - 3 - compensation                                    %}{#
          // however many pages are missing on the end, add offset to start                         #}{%
        endif                                                                                       %}{%
      else                                                                                          %}{%
        set start = 1                                                                               %}{%
      endif                                                                                         %}{%
      if paginator.number_pagers >= paginator.current_index + 2                                     %}{#
        // Check if the last page is beyond our range                                               #}{%
        set end = paginator.current_index + 2                                                       %}{#
        // End is beyond our range so we can safely set it to our range                             #}{%
        if paginator.current_index <= 3                                                             %}{#
          // check offset start, if on page 1 or 2 then set the end to page 5                       #}{%
          set end = 5                                                                               %}{%
        endif                                                                                       %}{%
      else                                                                                          %}{%
        set end = paginator.number_pagers                                                           %}{%
      endif                                                                                         %}{%
    endif                                                                                           %}{% filter trim %}
    <nav>                                                                                             {% endfilter %}{%
      set icon_first=config.extra.icon_first | default(value="svgs svgh angll")                     %}{%
      set icon_prev=config.extra.icon_prev | default(value="svgs svgh angl")                        %}{%
      set icon_next=config.extra.icon_next | default(value="svgs svgh angr")                        %}{%
      set icon_last=config.extra.icon_last | default(value="svgs svgh angrr")                       %}{%
      if paginator.previous                                                                         %}{% filter trim %}
        <a class="on outp" href="{{ paginator.first | safe }}" title="First Page">                    {% endfilter %}{%
        if icon_first                                                                               %}{% filter trim %}
          <i class="{{ icon_first }}" alt="First Page"></i>                                           {% endfilter %}{%
        else                                                                                        %}{% filter trim %}
          &#171;                                                                                      {% endfilter %}{%
        endif                                                                                       %}{% filter trim %}
        </a>                                                                                          {% endfilter %}{%
      else                                                                                          %}{% filter trim %}
        <span class="off outp">                                                                       {% endfilter %}{%
          if icon_first                                                                             %}{% filter trim %}
            <i class="{{ icon_first }}" alt="First Page"></i>                                         {% endfilter %}{%
          else                                                                                      %}{% filter trim %}
            &#171;                                                                                    {% endfilter %}{%
          endif                                                                                     %}{% filter trim %}
        </span>                                                                                       {% endfilter %}{%
      endif                                                                                         %}{%

      if paginator.previous                                                                         %}{% filter trim %}
        <a class="on outp" href="{{ paginator.previous | safe }}" title="Previous Page">              {% endfilter %}{%
        if icon_prev                                                                                %}{% filter trim %}
          <i class="{{ icon_prev }}" alt="Previous Page"></i>                                         {% endfilter %}{%
        else                                                                                        %}{% filter trim %}
          &#8249;                                                                                      {% endfilter %}{%
        endif                                                                                       %}{% filter trim %}
        </a>                                                                                          {% endfilter %}{%
      else                                                                                          %}{% filter trim %}
        <span class="off outp">                                                                       {% endfilter %}{%
          if icon_prev                                                                              %}{% filter trim %}
            <i class="{{ icon_prev }}" alt="Previous Page"></i>                                       {% endfilter %}{%
          else                                                                                      %}{% filter trim %}
            &#8249;                                                                                    {% endfilter %}{%
          endif                                                                                     %}{% filter trim %}
        </span>                                                                                       {% endfilter %}{%
      endif                                                                                         %}{%

      for i in range(start=start, end=end+1)                                                        %}{%
        if i == paginator.current_index                                                             %}{% filter trim %}
          <a class="inp on cnav" href="#">{{i}}</a>                                                   {% endfilter %}{%
        elif i > 1                                                                                  %}{% filter trim %}
          <a class="inp on" href="{{ paginator.base_url | safe }}{{ i ~ '/' }}">{{i}}</a>             {% endfilter %}{%
        else                                                                                        %}{% filter trim %}
          <a class="inp on" href="{{ paginator.first | safe }}">{{ i }}</a>                           {% endfilter %}{%
        endif                                                                                       %}{%
      endfor                                                                                        %}{%

      if paginator.next                                                                             %}{% filter trim %}
        <a class="on outp" href="{{ paginator.next | safe }}" title="Next Page">                      {% endfilter %}{%
        if icon_next                                                                                %}{% filter trim %}
          <i class="{{ icon_next }}" alt="Next Page"></i>                                             {% endfilter %}{%
        else                                                                                        %}{% filter trim %}
          &#8250;                                                                                     {% endfilter %}{%
        endif                                                                                       %}{% filter trim %}
        </a>                                                                                          {% endfilter %}{%
      else                                                                                          %}{% filter trim %}
        <span class="off outp">                                                                       {% endfilter %}{%
          if icon_next                                                                              %}{% filter trim %}
            <i class="{{ icon_next }}" alt="Next Page"></i>                                           {% endfilter %}{%
          else                                                                                      %}{% filter trim %}
            &#8250;                                                                                   {% endfilter %}{%
          endif                                                                                     %}{% filter trim %}
        </span>                                                                                       {% endfilter %}{%
      endif                                                                                         %}{%

      if paginator.last                                                                             %}{% filter trim %}
        <a class="on outp" href="{{ paginator.last | safe }}" title="Last Page">                      {% endfilter %}{%
        if icon_last                                                                                %}{% filter trim %}
          <i class="{{ icon_prev }}" alt="Last Page"></i>                                             {% endfilter %}{%
        else                                                                                        %}{% filter trim %}
          &#187;                                                                                      {% endfilter %}{%
        endif                                                                                       %}{% filter trim %}
        </a>                                                                                          {% endfilter %}{%
      else                                                                                          %}{% filter trim %}
        <span class="off outp">                                                                       {% endfilter %}{%
          if icon_last                                                                              %}{% filter trim %}
            <i class="{{ icon_prev }}" alt="Last Page"></i>                                           {% endfilter %}{%
          else                                                                                      %}{% filter trim %}
            &#187;                                                                                    {% endfilter %}{%
          endif                                                                                     %}{% filter trim %}
        </span>                                                                                       {% endfilter %}{%
      endif                                                                                         %}{% filter trim %}
    </nav>                                                                                            {% endfilter %}{%
  endif                                                                                             %}{%
endmacro                                                                                            %}
